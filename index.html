<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cálculo de Idade Gestacional e DPP</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    label, p {
      margin-bottom: 5px;
    }
    input {
      margin-bottom: 10px;
      padding: 5px;
      width: 200px;
    }
    button {
      padding: 8px 16px;
      margin-right: 10px;
      cursor: pointer;
    }
    #consultasContainer input {
      display: block;
      margin-bottom: 5px;
    }
    #resultados {
      margin-top: 20px;
      padding: 10px;
      background-color: #f5f5f5;
      border: 1px solid #ccc;
    }
    .consulta-result {
      border-bottom: 1px solid #ccc;
      padding: 5px 0;
    }
    .consulta-result:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <h1>Cálculo de Idade Gestacional e DPP</h1>
  
  <!-- Campo para DUM (dd-mm-aaaa) -->
  <label for="dum">Data da Última Menstruação (DUM) - Formato (dd-mm-aaaa):</label><br />
  <input type="text" id="dum" placeholder="dd-mm-aaaa" />

  <!-- Botão para adicionar datas de consultas anteriores -->
  <p>
    <button type="button" onclick="adicionarConsulta()">Adicionar data de consulta anterior</button>
  </p>

  <!-- Container onde serão adicionados os campos de data de consultas anteriores -->
  <div id="consultasContainer"></div>

  <!-- Botão para calcular -->
  <p>
    <button type="button" onclick="calcular()">Calcular</button>
  </p>

  <!-- Área de resultados -->
  <div id="resultados"></div>

  <script>
    /**
     * FUNÇÃO 1:
     * Ao digitar em um campo de texto, qualquer caractere não numérico será ignorado
     * e o valor será reformatado no padrão dd-mm-aaaa (com hífens).
     * Exemplo: 
     *   - "16102024" => "16-10-2024"
     *   - "16.10.2024" => "16-10-2024"
     *   - "16/10/2024" => "16-10-2024"
     */
    function formatarEntradaData(event) {
      // Pega somente dígitos
      let val = event.target.value.replace(/\D/g, '');
      
      // Limita em 8 caracteres (ddmm aaaa) para evitar digitações maiores
      if (val.length > 8) {
        val = val.substring(0, 8);
      }

      // Monta o formato progressivamente (dd-mm-aaaa)
      let resultado = '';
      if (val.length > 0) {
        resultado = val.substring(0, 2); // dd
      }
      if (val.length >= 3) {
        resultado += '-' + val.substring(2, 4); // -mm
      }
      if (val.length >= 5) {
        resultado += '-' + val.substring(4, 8); // -aaaa
      }

      event.target.value = resultado;
    }

    /**
     * FUNÇÃO 2:
     * Converte string "dd-mm-aaaa" (após formatação) em objeto Date do JS.
     * Retorna null se inválido (p.ex., 31-02-2024).
     */
    function parseDataDDMMAAAA(dataStr) {
      if (!dataStr) return null;
      const partes = dataStr.split('-');
      if (partes.length !== 3) return null;

      const [diaStr, mesStr, anoStr] = partes;
      const dia = parseInt(diaStr, 10);
      const mes = parseInt(mesStr, 10);
      const ano = parseInt(anoStr, 10);

      // Verifica se são números válidos
      if (isNaN(dia) || isNaN(mes) || isNaN(ano)) return null;

      // new Date(ano, mes-1, dia) lida com diferentes meses e ano bissexto
      const data = new Date(ano, mes - 1, dia);

      // Verificação extra: se a data gerada bate com dia, mês, ano inseridos
      if (
        data.getDate() !== dia ||
        data.getMonth() !== (mes - 1) ||
        data.getFullYear() !== ano
      ) {
        return null;
      }

      return data;
    }

    /**
     * FUNÇÃO 3:
     * Cria um input para data de consulta anterior e adiciona ao container.
     */
    function adicionarConsulta() {
      const container = document.getElementById('consultasContainer');

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'dd-mm-aaaa';

      // Adiciona listener para formatar enquanto digita
      input.addEventListener('input', formatarEntradaData);

      container.appendChild(input);
    }

    /**
     * FUNÇÃO 4:
     * Cálculo principal. Para cada data de consulta, calcula idade gestacional.
     */
    function calcular() {
      const resultadosDiv = document.getElementById('resultados');
      resultadosDiv.innerHTML = ''; // Limpa resultados anteriores

      // Lê a DUM
      const dumStr = document.getElementById('dum').value;
      const dumDate = parseDataDDMMAAAA(dumStr);

      if (!dumDate) {
        resultadosDiv.innerHTML = "<p style='color:red;'>Por favor, informe a DUM corretamente (dd-mm-aaaa).</p>";
        return;
      }

      // Calcula DPP = DUM + 280 dias (40 semanas)
      const dppDate = new Date(dumDate);
      dppDate.setDate(dppDate.getDate() + 280); 
      const dppFormatada = formatarData(dppDate);

      // Mensagem inicial com a DPP
      let mensagem = `<p><strong>Data Provável do Parto (DPP):</strong> ${dppFormatada}</p>`;
      
      const consultasContainer = document.getElementById('consultasContainer');
      const inputsConsulta = consultasContainer.querySelectorAll('input');

      // Se não houver datas de consulta, apenas exibe a DPP.
      if (inputsConsulta.length === 0) {
        mensagem += `<p style="color:red;">Nenhuma data de consulta anterior foi adicionada.</p>`;
        resultadosDiv.innerHTML = mensagem;
        return;
      }

      let resultadosConsultas = '';
      inputsConsulta.forEach((input, index) => {
        const consultaStr = input.value.trim();
        if (!consultaStr) {
          resultadosConsultas += `
            <div class="consulta-result" style="color:red;">
              <p>Consulta ${index + 1}: data não preenchida.</p>
            </div>
          `;
          return;
        }

        const consultaDate = parseDataDDMMAAAA(consultaStr);
        if (!consultaDate) {
          resultadosConsultas += `
            <div class="consulta-result" style="color:red;">
              <p>Consulta ${index + 1}: data "${consultaStr}" inválida.</p>
            </div>
          `;
          return;
        }

        // Calcula IG em dias
        const diffEmMilissegundos = consultaDate - dumDate;
        const diffEmDias = Math.floor(diffEmMilissegundos / (1000 * 60 * 60 * 24));

        if (diffEmDias < 0) {
          resultadosConsultas += `
            <div class="consulta-result" style="color:red;">
              <p>Consulta ${index + 1} (${formatarData(consultaDate)}): 
              não é possível ter consulta antes da DUM.</p>
            </div>
          `;
          return;
        }

        // Converte dias em semanas
        const idadeGestSemanas = diffEmDias / 7;
        const semanas = Math.floor(idadeGestSemanas);
        const diasRestantes = Math.floor((idadeGestSemanas - semanas) * 7);

        resultadosConsultas += `
          <div class="consulta-result">
            <p><strong>Consulta ${index + 1}:</strong> ${formatarData(consultaDate)}</p>
            <p>IG nessa data: ${semanas} semanas e ${diasRestantes} dias</p>
          </div>
        `;
      });

      resultadosDiv.innerHTML = mensagem + resultadosConsultas;
    }

    /**
     * FUNÇÃO 5:
     * Formata data para dd/mm/aaaa (apenas para exibição, não para o input).
     */
    function formatarData(data) {
      const dia = String(data.getDate()).padStart(2, '0');
      const mes = String(data.getMonth() + 1).padStart(2, '0');
      const ano = data.getFullYear();
      return `${dia}/${mes}/${ano}`;
    }

    // ADICIONA listener ao campo da DUM, para formatar enquanto digita.
    document.getElementById('dum').addEventListener('input', formatarEntradaData);
  </script>
</body>
</html>

